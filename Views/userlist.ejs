<html>
<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
		<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
		<script src="http://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script src="//cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
	<style>
		header{
			height: 80px;
			background-color: white;
			padding: 10px
		}
		@media(max-width: 800px){
			.mobile-responsive{
				display: none;
			}
		}
    .allSides
      {
        box-shadow: 0 0 10px rgba(0,0,0,0.6);
        -moz-box-shadow: 0 0 10px rgba(0,0,0,0.6);
        -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.6);
        -o-box-shadow: 0 0 10px rgba(0,0,0,0.6);
      }
	</style>
</head>

<body>
<% include partials/header %>
<div id="main">

<div id="page-content-wrapper" style="padding:0;margin-top:60px;margin-left:50px"> <!--Margin Top is new-->
         <div class="container-fluid page-content-div" style="padding:0">
            <div class="row">
               <div class="col-lg-12 scoll-possible" style="padding:0">



<div style="margin-left:20px;margin-right:20px">

<div class="modal fade" id="popUp" role="dialog" style="z-index:9999">
    <div class="modal-dialog">

      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">×</button>
          <h4 class="modal-title" id="mailheader">Send Reminder Mail</h4>
        </div>
        <div class="modal-body">
        <!------------------------------------------------------------------------------------>
        <div class="form-horizontal"> <!-- form -->
          <div class="form-group">
            <label class="control-label col-sm-2" for="email">To:</label>
            <div class="col-sm-10">
              <input type="email" name="username" class="form-control" id="emailPop" readonly="">
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-2">Subject:</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="subject" id="subject" placeholder="Title">
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-12"><!--Body-->
               <div id="editor" style="width:100%;height:200px;border-radius:5px;border:1;"  ></div> 
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <button class="btn btn-default" id="mailbutton" style="float:right" data-dismiss="modal">Send</button>
            </div>
          </div>
        </div> <!-- form -->
        <!---------------------------------------------------------------------------------->
        </div>
      </div>
    </div>
  </div>
  
<div class="modal fade" id="delete" role="dialog" style="z-index:9999">
    <div class="modal-dialog">

      <div class="modal-content">
        <div class="modal-body">
        <!------------------------------------------------------------------------------------>
        <div class="form-horizontal"> <!-- form -->
          <div class="jconfirm-title-c">
			<span class="jconfirm-icon-c"></span>
			<span class="jconfirm-title" id="what"></span>
		  </div>
         <div class="jconfirm-content" id="jconfirm-box86121">
			<div id="sure"></div>
			</div>
		<div class="jconfirm-buttons">
		<button type="button" class="btn btn-success" id="yes" data-dismiss="modal">Yes</button>
		<button type="button" class="btn btn-danger" data-dismiss="modal">No</button>
		</div>
        </div> <!-- form -->
        <!---------------------------------------------------------------------------------->
        </div>
      </div>
    </div>
  </div>


<div class="modal fade" id="updateUser" role="dialog" style="z-index: 9999; display: none;">
    <div class="modal-dialog">

      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">×</button>
          <h4 class="modal-title" id="usernamePop"></h4>
        </div>
        <div class="modal-body">
        <!------------------------------------------------------------------------------------>
  <div class="form-horizontal">
          <div class="form-group">
            <div class="col-lg-5 col-lg-offset-3" style="width:50%">
              <input type="text" name="_id" style="text-align:center;display:none;" class="form-control" id="_id" readonly="">
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-2">Username:</label>
            <div class="col-sm-10">
              <input type="text" name="username" class="form-control" id="username" placeholder="Username">
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-2">Phone:</label>
            <div class="col-sm-10">
              <input type="text" name="phone" class="form-control" id="phone" placeholder="Phone" maxlength="15">
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-2">City:</label>
            <div class="col-sm-10">
              <input type="text" name="city" class="form-control" id="city" placeholder="City">
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-2">Status:</label>
            <div class="col-sm-10">
              <select class="form-control" id="status" name="status">
                  <option name="pending" value="Pending">Pending</option>
                  <option name="confirmed" value="Confirmed">Confirmed</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-2">Role:</label>
            <div class="col-sm-10">
              <select class="form-control" id="role" name="role">
                <option name="user" value="user">User</option>
                  <option name="admin" value="commuity manager">Community Builder</option>
                <option name="admin" value="admin">Admin</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <button class="btn btn-default" id="editsubmit" data-dismiss="modal">Update</button>
            </div>
          </div>
        </div>
        <!---------------------------------------------------------------------------------->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

      <center><p id="msgalert"></p></center>

      <div class="form-control allSides" id="roleFilterTitle" style="float: left;width:90px;font-weight:bold;">
        User List
      </div>

      <select class="form-control filter-button" id="roleFilter" name="filter" style="float: right;margin-left: 10px;width:150px">
      <option name="user" value="All">All</option>
        <option name="user" value="admin">Admins</option>
          <option name="admin" value="user">Users</option>
          <option name="commuity manager" value="commuity manager">Community Builder</option>
      </select>

      <select class="form-control filter-button" id="statusFilter" name="statusFilter" style="float: right;margin-left: 10px;width:150px">
      <option name="user" value="All">All</option>
          <option name="pending" value="Pending">Pending</option>
      <option name="confirmed" value="Confirmed">Confirmed</option>
      </select>

      <button onclick="refresh()" class="btn btn-default" style="float: right;background-color: #2D312C;color: #fff">
        <span class="glyphicon glyphicon-refresh"></span> Refresh
      </button>

      <br>
      <br>
      <br>
	  <div class="table-wrapper">
        <div id="usertable_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
	  <table id="datatable" class="table table-striped table-bordered nowrap dataTable no-footer">
        <thead>
            <tr>
                <th>Email</th>
                <th>Phone</th>
                <th>City</th>
                <th>Status</th>
                <th>Role</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="tablebody">
        </tbody>
     </table>
	 </div>
	 </div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>

<script>
<% include partials/script %>

var editor = new Quill('#editor', {
    theme: 'snow'
  });

	function update(tr)
	{
		var arr=tr.childNodes;
		var Pop=document.getElementById("usernamePop");
		Pop.innerHTML="update "+arr[0].innerHTML;
		var email=document.getElementById("username");
		email.value=arr[0].innerHTML;
		var phone=document.getElementById("phone");
		phone.value=arr[1].innerHTML;
		var city=document.getElementById("city");
		city.value=arr[2].innerHTML;
		var status=document.getElementById("status");
		var role=document.getElementById("role");
		var edit=document.getElementById("editsubmit");
				
		edit.onclick=function()
		{	
			var req=new XMLHttpRequest();
			req.open("POST","/update");
			req.setRequestHeader("Content-Type", "application/json");
			req.onload=function()
			{
				arr[0].innerHTML=email.value;
				arr[1].innerHTML=phone.value;
				arr[2].innerHTML=city.value;
				arr[3].innerHTML=status.value;
				arr[4].innerHTML=role.value;
			}
			req.send(JSON.stringify({'old':arr[0].innerHTML,'email':email.value,'phone':phone.value,'city':city.value,'status':status.value,'role':role.value}));
		}
	}
	
	function del(tr)
	{
    var what=document.getElementById("what");
    var sure=document.getElementById("sure");
    var btn=document.getElementById("yes");
    var flag;
    if(tr.flag=="0")
    {
      what.innerHTML="Deactivate User ?";
      sure.innerHTML="Are you really want to deactivate "+tr.email;
      flag="1";
    }
    else
    {
      what.innerHTML="Activate User ?";
      sure.innerHTML="Are you really want to activate "+tr.email;
      flag="0";
    }
    btn.onclick=function()
    {
      var req=new XMLHttpRequest();
			req.open("POST","/yes");
			req.setRequestHeader("Content-Type", "application/json");
			req.onload=function()
			{
        refresh();
			}
			req.send(JSON.stringify({'id':tr._id,'flag':flag}));
    }
	}
	
	function send(tr)
	{
		var btn=document.getElementById("mailbutton");
		var id=document.getElementById("emailPop");
		var sub=document.getElementById("subject");
		var arr=tr.childNodes;
		id.value=arr[0].innerHTML;
		btn.onclick=function()
		{
			var mail=new XMLHttpRequest();
			mail.open("POST","/send");
			mail.setRequestHeader("Content-Type", "application/json");
			mail.send(JSON.stringify({'email':arr[0].innerHTML,'sub':sub.value,'write':editor.container.firstChild.innerHTML}));
		}
	}
	
	var status1=document.getElementById("statusFilter");
	var role1=document.getElementById("roleFilter");
	print();
	status1.onchange=print;
	role1.onchange=print;

	function print()
	{
		var table=$('#datatable').DataTable();
		table.clear().draw();
		table.destroy();
		
		var role=role1.value;
		var status=status1.value;
		
		$(document).ready(function() {
		$('#datatable').DataTable({
			"processing": true,
			"serverSide": true,
			"autoWidth": false,
			"paging":true,
			"dataSrc":"",
			"ajax": {
				"url": "/userlist",
				"data": function(data)
				{
					data.role= role;
					data.status= status;
				},
				"type": "POST"
			},
			"columns": [
				{ "data": "email" },
				{ "data": "phone" },
				{ "data": "city" },
				{ "data": "status" },
        { "data": "role" },
				{ "data":  "flag" }
			],
			columnDefs: [
			   {
				   targets:-1, // Start with the last
				   render: function ( data, type, row, meta ) {
              if(row.flag=="0")
                  data = '<button onclick="send(event.target.parentNode.parentNode.parentNode)" class="btn btn-primary btn-sm emailbtn actionbtns" style="background:#000 type="button" data-toggle="modal" data-target="#popUp""><span class="fa fa-envelope" style="color:#fff"></span></button><button onclick="update(event.target.parentNode.parentNode.parentNode)" class="btn btn-primary btn-sm editbtn actionbtns" type="button" data-toggle="modal" data-target="#updateUser"><span class="fa fa-edit"></span></button><button id="delbtn" class="btn btn-warning btn-sm activebtn actionbtns" onclick=\'del('+JSON.stringify(row)+')\' data-toggle="modal" data-target="#delete"><span id="delspan" class="fa fa-times-circle"></span></button>';
              else
                  data = '<button onclick="send(event.target.parentNode.parentNode.parentNode)" class="btn btn-primary btn-sm emailbtn actionbtns" style="background:#000 type="button" data-toggle="modal" data-target="#popUp""><span class="fa fa-envelope" style="color:#fff"></span></button><button onclick="update(event.target.parentNode.parentNode.parentNode)" class="btn btn-primary btn-sm editbtn actionbtns" type="button" data-toggle="modal" data-target="#updateUser"><span class="fa fa-edit"></span></button><button id="delbtn" class="btn btn-success btn-sm activebtn actionbtns" onclick=\'del('+JSON.stringify(row)+')\' data-toggle="modal" data-target="#delete"><span id="delspan" class="fa fa-check-circle"></span></button>';
					   return data;
				   }
			   }
		   ]
		});
	} );
	}
	function refresh() 
	{
		$('#datatable').DataTable().ajax.reload(null, false);
  }
</script>

</html>